{% extends "base.html" %}

{% block title %}Distribute Device - VERXID System{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-green-50 py-8">
    <div class="max-w-4xl mx-auto px-6">
        
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
            <div class="flex items-center">
                <a href="{{ url_for('algon_dashboard') }}" class="p-2 rounded-xl hover:bg-gray-100 transition-colors mr-4">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Distribute Device</h1>
                    <p class="text-gray-600 mt-1">Complete the distribution process for this device</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Device Information -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-green-100 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Device Information</h2>
                        <p class="text-gray-600">Details about the device being distributed</p>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Serial Number</div>
                        <div class="text-xl font-bold text-gray-900">{{ device.serial_number or 'Pending SN' }}</div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">IMEI 1</div>
                        <div class="text-lg font-mono text-gray-900">{{ device.imei1 }}</div>
                    </div>
                    
                    {% if device.imei2 %}
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">IMEI 2</div>
                        <div class="text-lg font-mono text-gray-900">{{ device.imei2 }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Device Type</div>
                        <div class="text-lg text-gray-900">{{ device.device_type or 'VERXID Tablet' }}</div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Model</div>
                        <div class="text-lg text-gray-900">{{ device.model or 'VERXID Tablet' }}</div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <div class="text-sm font-semibold text-green-600 uppercase tracking-wider mb-2">Status</div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800 border border-green-200">
                            Ready for Distribution
                        </span>
                    </div>
                </div>
            </div>

            <!-- Distribution Form -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-blue-100 rounded-xl mr-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Recipient Information</h2>
                        <p class="text-gray-600">Enter details of the device recipient</p>
                    </div>
                </div>

                <form method="POST" action="{{ url_for('distribute_device') }}" class="space-y-8" id="distribution-form">
                    <input type="hidden" name="device_id" value="{{ device.id }}">
                    
                    <!-- Section A: Device Information (Pre-filled) -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-blue-900 mb-4">Section A: Device Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Device Type</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200">VERXID Digital Registration Device</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Device Make/Model</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200">{{ device.model or 'VERXID Tablet' }}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Device Serial Number</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200 font-mono">{{ device.serial_number or 'Pending SN' }}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">IMEI 1</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200 font-mono">{{ device.imei1 }}</div>
                            </div>
                            {% if device.imei2 %}
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">IMEI 2</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200 font-mono">{{ device.imei2 }}</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Accessories Issued -->
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Accessories Issued (Check all that apply & specify quantity)</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="charger" name="accessories" value="charger" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="charger" class="text-gray-700">Charger</label>
                                    <input type="number" name="charger_qty" min="0" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center">
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="power_cable" name="accessories" value="power_cable" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="power_cable" class="text-gray-700">Power Cable</label>
                                    <input type="number" name="power_cable_qty" min="0" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center">
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="sim_card" name="accessories" value="sim_card" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="sim_card" class="text-gray-700">SIM Card</label>
                                    <input type="text" name="sim_network" placeholder="Network" class="w-24 px-2 py-1 border border-gray-300 rounded text-sm">
                                    <input type="text" name="sim_number" placeholder="Number" class="w-32 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="protective_case" name="accessories" value="protective_case" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="protective_case" class="text-gray-700">Protective Case</label>
                                    <input type="number" name="protective_case_qty" min="0" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center">
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="stylus_pen" name="accessories" value="stylus_pen" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="stylus_pen" class="text-gray-700">Stylus Pen</label>
                                    <input type="number" name="stylus_pen_qty" min="0" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center">
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="user_manual" name="accessories" value="user_manual" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="user_manual" class="text-gray-700">User Manual/Quick Guide</label>
                                    <input type="number" name="user_manual_qty" min="0" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center">
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="other_accessory" name="accessories" value="other" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <label for="other_accessory" class="text-gray-700">Other</label>
                                    <input type="text" name="other_specify" placeholder="Specify" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                                    <input type="number" name="other_qty" min="0" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Device Condition -->
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Condition upon Issuance</label>
                            <div class="flex space-x-6">
                                <label class="flex items-center">
                                    <input type="radio" name="device_condition" value="new" class="w-5 h-5 text-green-600 border-gray-300 focus:ring-green-500" required>
                                    <span class="ml-2 text-gray-700">New</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="device_condition" value="good" class="w-5 h-5 text-green-600 border-gray-300 focus:ring-green-500">
                                    <span class="ml-2 text-gray-700">Good</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="device_condition" value="fair" class="w-5 h-5 text-green-600 border-gray-300 focus:ring-green-500">
                                    <span class="ml-2 text-gray-700">Fair</span>
                                </label>
                            </div>
                            <div class="mt-3">
                                <label for="device_defects" class="block text-sm font-semibold text-gray-700 mb-2">Note any existing minor defects if any</label>
                                <textarea name="device_defects" id="device_defects" rows="2" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                                          placeholder="Describe any minor defects or issues..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section B: Recipient Information -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-green-900 mb-4">Section B: Recipient Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="recipient_name" class="block text-sm font-semibold text-gray-700 mb-2">Full Name of Recipient *</label>
                                <input type="text" name="recipient_name" id="recipient_name" required 
                                       class="block w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                       placeholder="Enter recipient's full name">
                            </div>
                            <div>
                                <label for="recipient_designation" class="block text-sm font-semibold text-gray-700 mb-2">Designation/Role *</label>
                                <input type="text" name="recipient_designation" id="recipient_designation" required 
                                       class="block w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                       placeholder="e.g., Health Worker, Registration Officer">
                            </div>
                            <div>
                                <label for="staff_id" class="block text-sm font-semibold text-gray-700 mb-2">Staff ID Number</label>
                                <input type="text" name="staff_id" id="staff_id" 
                                       class="block w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                       placeholder="Enter staff identification number">
                            </div>
                            <div>
                                <label for="registration_center_name" class="block text-sm font-semibold text-gray-700 mb-2">Registration Center Name *</label>
                                <input type="text" name="registration_center_name" id="registration_center_name" required 
                                       class="block w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                       placeholder="Enter registration center name">
                            </div>
                            <div class="md:col-span-2">
                                <label for="registration_center_address" class="block text-sm font-semibold text-gray-700 mb-2">Registration Center Full Address *</label>
                                <textarea name="registration_center_address" id="registration_center_address" rows="2" required 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                                          placeholder="Enter complete address of registration center"></textarea>
                            </div>
                            <div>
                                <label for="recipient_phone" class="block text-sm font-semibold text-gray-700 mb-2">Contact Phone Number *</label>
                                <input type="tel" name="recipient_phone" id="recipient_phone" required 
                                       class="block w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                       placeholder="e.g., 08123456789">
                            </div>
                            <div>
                                <label for="recipient_email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                                <input type="email" name="recipient_email" id="recipient_email" 
                                       class="block w-full px-4 py-3 border border-gray-300 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                                       placeholder="recipient@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- Section C: Issuing Authority Information (Auto-populated) -->
                    <div class="bg-purple-50 border border-purple-200 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-purple-900 mb-4">Section C: Issuing Authority Information (ALGON)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Issued By (Name of Representative/Partner Staff)</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200">{{ current_user.full_name }}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Title/Designation</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200">ALGON Focal Person</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Issuing Office/Location</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200">{{ current_user.lga.name if current_user.lga else 'N/A' }}, {{ current_user.state.name if current_user.state else 'N/A' }}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Issuance</label>
                                <div class="bg-white px-4 py-3 rounded-lg border border-gray-200">{{ current_date.strftime('%d/%m/%Y') if current_date else '' }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section D: Terms of Use and Responsibilities -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-yellow-900 mb-4">Section D: Terms of Use and Responsibilities of Recipient</h4>
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <p class="text-gray-800 mb-4 leading-relaxed">I, the undersigned recipient, acknowledge receipt of the VERXID device and accessories listed above and agree to the following terms and responsibilities:</p>
                            
                            <div class="space-y-3 text-sm text-gray-700">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">1</span>
                                    </div>
                                    <div>
                                        <strong>Purpose of Use:</strong> The device is to be used exclusively for official duties related to Birth Registration, including data capture, management, and transmission as per training and protocols.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">2</span>
                                    </div>
                                    <div>
                                        <strong>Safekeeping and Care:</strong> I am responsible for the safekeeping and proper care of the device and its accessories. I will take reasonable precautions to protect it from damage, loss, theft, and unauthorized use.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">3</span>
                                    </div>
                                    <div>
                                        <strong>Data Security & Confidentiality:</strong> I will adhere to all data security and confidentiality protocols provided during training. I will not share login credentials, and I will ensure the device is secured when not in use.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">4</span>
                                    </div>
                                    <div>
                                        <strong>Reporting Issues:</strong> I will promptly report any malfunction, damage, loss, or theft of the device or its accessories to my supervisor and the designated UNICEF/Partner contact person within 24-48 hours.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">5</span>
                                    </div>
                                    <div>
                                        <strong>No Unauthorized Modifications:</strong> I will not attempt to install unauthorized software, tamper with the hardware, or make any unauthorized modifications to the device or its operating system.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">6</span>
                                    </div>
                                    <div>
                                        <strong>Return of Device:</strong> I will return the device and all issued accessories to UNICEF or its designated partner upon request, upon termination/transfer from my current role or health facility.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">7</span>
                                    </div>
                                    <div>
                                        <strong>Liability:</strong> I understand that I may be held accountable for negligent loss or damage to the device due to failure to exercise due care.
                                    </div>
                                </div>
                                
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                        <span class="text-blue-600 font-semibold text-xs">8</span>
                                    </div>
                                    <div>
                                        <strong>Adherence to Protocols:</strong> I will use the device in accordance with all training, guidelines, and operational protocols provided by UNICEF and the National Population Commission (NPC) for birth registration.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms Acceptance Checkbox -->
                        <div class="flex items-start space-x-3 bg-white rounded-lg p-4">
                            <input type="checkbox" id="terms_accepted" name="terms_accepted" required 
                                   class="mt-1 w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <label for="terms_accepted" class="text-gray-700 font-medium">
                                I have read, understood, and agree to abide by all Terms of Use and Responsibilities outlined above. *
                            </label>
                        </div>
                    </div>

                    <!-- Section E: Acknowledgement and Signatures -->
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-red-900 mb-6">Section E: Acknowledgement and Signatures</h4>
                        
                        <!-- Recipient Acknowledgement -->
                        <div class="bg-white rounded-lg p-4 mb-6">
                            <p class="text-gray-800 mb-4">I, <strong id="recipient-name-acknowledgment">[Recipient Name]</strong>, hereby acknowledge that I have received the VERXID device and accessories as detailed in Section A, in the condition stated. I have read, understood, and agree to abide by the Terms of Use and Responsibilities outlined in Section D.</p>
                        </div>
                        
                        <!-- Recipient Signature -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Recipient's Signature *</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 bg-gray-50">
                                <canvas id="recipient-signature-pad" width="600" height="150" 
                                        class="cursor-crosshair bg-white rounded-lg border border-gray-200 w-full"></canvas>
                                <div class="flex justify-between mt-3">
                                    <button type="button" id="clear-recipient-signature" 
                                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300/20">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Clear
                                    </button>
                                    <span class="text-sm text-gray-600 self-center">Date: {{ current_date.strftime('%d/%m/%Y') if current_date else '' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Issuer (ALGON) Signature -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Issuer's Signature (ALGON Focal) *</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 bg-gray-50">
                                <canvas id="issuer-signature-pad" width="600" height="150" 
                                        class="cursor-crosshair bg-white rounded-lg border border-gray-200 w-full"></canvas>
                                <div class="flex justify-between mt-3">
                                    <button type="button" id="clear-issuer-signature" 
                                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300/20">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Clear
                                    </button>
                                    <button type="button" id="load-saved-issuer-signature" 
                                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 border border-blue-300 rounded-lg hover:bg-blue-100 focus:outline-none focus:ring-4 focus:ring-blue-300/20">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                                        </svg>
                                        Use Saved Signature
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mt-2">Printed Name: {{ current_user.full_name }}</p>
                            </div>
                        </div>

                        <!-- Witness Signature -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Witness Signature *</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 bg-gray-50">
                                <canvas id="witness-signature-pad" width="600" height="150" 
                                        class="cursor-crosshair bg-white rounded-lg border border-gray-200 w-full"></canvas>
                                <div class="flex justify-between mt-3">
                                    <button type="button" id="clear-witness-signature" 
                                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-300/20">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Clear
                                    </button>
                                    <span class="text-sm text-gray-600 self-center">Date: {{ current_date.strftime('%d/%m/%Y') if current_date else '' }}</span>
                                </div>
                                <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="witness_name" class="block text-sm font-medium text-gray-700 mb-1">Witness Printed Name *</label>
                                        <input type="text" name="witness_name" id="witness_name" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                               placeholder="Enter witness full name">
                                    </div>
                                    <div>
                                        <label for="witness_role" class="block text-sm font-medium text-gray-700 mb-1">Witness Designation/Role *</label>
                                        <input type="text" name="witness_role" id="witness_role" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                               placeholder="e.g., DCR Focal, Supervisor">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-4 pt-6">
                        <button type="submit" id="submit-distribution" disabled
                                class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-4 px-6 rounded-xl hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-4 focus:ring-green-300/20 focus:ring-offset-2 transition-all duration-200 transform hover:scale-[1.02] shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <div class="flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Complete Distribution
                            </div>
                        </button>
                        
                        <a href="{{ url_for('algon_dashboard') }}" 
                           class="flex-1 bg-gray-100 text-gray-700 font-semibold py-4 px-6 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-4 focus:ring-gray-300/20 focus:ring-offset-2 transition-all duration-200 text-center flex items-center justify-center">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let recipientSignaturePad;
let issuerSignaturePad;
let witnessSignaturePad;

document.addEventListener('DOMContentLoaded', function() {
    initializeSignaturePads();
    setupFormValidation();
    updateRecipientNameInAcknowledgment();
});

// Initialize signature pads
function initializeSignaturePads() {
    recipientSignaturePad = createSignaturePad('recipient-signature-pad');
    issuerSignaturePad = createSignaturePad('issuer-signature-pad');
    witnessSignaturePad = createSignaturePad('witness-signature-pad');
    
    // Clear buttons
    document.getElementById('clear-recipient-signature').addEventListener('click', () => {
        recipientSignaturePad.clear();
        checkFormValidity();
    });
    
    document.getElementById('clear-issuer-signature').addEventListener('click', () => {
        issuerSignaturePad.clear();
        checkFormValidity();
    });
    
    document.getElementById('clear-witness-signature').addEventListener('click', () => {
        witnessSignaturePad.clear();
        checkFormValidity();
    });
    
    // Load saved issuer signature
    document.getElementById('load-saved-issuer-signature').addEventListener('click', () => {
        const savedSignature = '{{ current_user.signature_data if current_user.signature_data else "" }}';
        if (savedSignature) {
            issuerSignaturePad.loadSignature(savedSignature);
            checkFormValidity();
        } else {
            alert('No saved signature found.');
        }
    });
}

// Create signature pad
function createSignaturePad(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    const pad = {
        canvas: canvas,
        ctx: ctx,
        drawing: false,
        isEmpty: true,
        
        startDrawing: function(e) {
            this.drawing = true;
            this.isEmpty = false;
            const rect = this.canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            this.ctx.beginPath();
            this.ctx.moveTo(x, y);
        },
        
        draw: function(e) {
            if (!this.drawing) return;
            
            const rect = this.canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            this.ctx.lineTo(x, y);
            this.ctx.stroke();
        },
        
        stopDrawing: function() {
            this.drawing = false;
            checkFormValidity();
        },
        
        clear: function() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.isEmpty = true;
        },
        
        getDataURL: function() {
            return this.canvas.toDataURL();
        },
        
        loadSignature: function(dataURL) {
            const img = new Image();
            img.onload = () => {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(img, 0, 0);
                this.isEmpty = false;
                checkFormValidity();
            };
            img.src = dataURL;
        }
    };
    
    // Set up canvas styling
    pad.ctx.strokeStyle = '#000';
    pad.ctx.lineWidth = 2;
    pad.ctx.lineCap = 'round';
    pad.ctx.lineJoin = 'round';
    
    // Mouse events
    canvas.addEventListener('mousedown', (e) => pad.startDrawing(e));
    canvas.addEventListener('mousemove', (e) => pad.draw(e));
    canvas.addEventListener('mouseup', () => pad.stopDrawing());
    canvas.addEventListener('mouseout', () => pad.stopDrawing());
    
    // Touch events
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        pad.startDrawing(e);
    });
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        pad.draw(e);
    });
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        pad.stopDrawing();
    });
    
    return pad;
}

// Set up form validation
function setupFormValidation() {
    const phoneInput = document.getElementById('recipient_phone');
    const recipientNameInput = document.getElementById('recipient_name');
    const termsCheckbox = document.getElementById('terms_accepted');
    
    // Phone validation
    phoneInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
        if (this.value.length > 14) {
            this.value = this.value.slice(0, 14);
        }
        checkFormValidity();
    });
    
    // Update acknowledgment when recipient name changes
    recipientNameInput.addEventListener('input', updateRecipientNameInAcknowledgment);
    
    // Terms checkbox validation
    termsCheckbox.addEventListener('change', checkFormValidity);
    
    // All required fields validation
    document.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
        field.addEventListener('input', checkFormValidity);
        field.addEventListener('change', checkFormValidity);
    });
    
    // Form submission
    document.getElementById('distribution-form').addEventListener('submit', handleFormSubmit);
}

// Update recipient name in acknowledgment
function updateRecipientNameInAcknowledgment() {
    const recipientName = document.getElementById('recipient_name').value || '[Recipient Name]';
    document.getElementById('recipient-name-acknowledgment').textContent = recipientName;
}

// Check form validity
function checkFormValidity() {
    const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');
    const allFieldsValid = Array.from(requiredFields).every(field => field.value.trim() !== '');
    
    const termsAccepted = document.getElementById('terms_accepted').checked;
    const hasRecipientSignature = !recipientSignaturePad.isEmpty;
    const hasIssuerSignature = !issuerSignaturePad.isEmpty;
    const hasWitnessSignature = !witnessSignaturePad.isEmpty;
    
    const phoneValid = document.getElementById('recipient_phone').value.length >= 10;
    
    const isValid = allFieldsValid && termsAccepted && hasRecipientSignature && 
                   hasIssuerSignature && hasWitnessSignature && phoneValid;
    
    document.getElementById('submit-distribution').disabled = !isValid;
}

// Handle form submission
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-distribution');
    const originalText = submitBtn.innerHTML;
    
    if (!confirm('Are you sure you want to complete the distribution? This action cannot be undone.')) {
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    try {
        const formData = new FormData(e.target);
        
        // Add signature data
        formData.append('recipient_signature', recipientSignaturePad.getDataURL());
        formData.append('issuer_signature', issuerSignaturePad.getDataURL());
        formData.append('witness_signature', witnessSignaturePad.getDataURL());
        
        const response = await fetch(e.target.action, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                alert('Device distribution completed successfully!');
                window.location.href = '{{ url_for("algon_dashboard") }}';
            } else {
                alert('Error: ' + result.error);
            }
        } else {
            throw new Error('Network response was not ok');
        }
        
    } catch (error) {
        console.error('Distribution error:', error);
        alert('An error occurred while processing the distribution. Please try again.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Check form validity periodically for signature changes
setInterval(checkFormValidity, 1000);
</script>
{% endblock %}